<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b5">
  <title>Werksplan‑Editor (PWA)</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <span class="logo">BN</span>
      <strong>Werksplan‑Editor</strong>
    </div>
    <nav class="steps">
      <button data-step="1" class="step active">1 Bild</button>
      <button data-step="2" class="step">2 Automatik</button>
      <button data-step="3" class="step">3 Nacharbeit</button>
      <button data-step="4" class="step">4 Kalibrieren</button>
      <button data-step="5" class="step">5 Standorte</button>
      <button data-step="6" class="step">6 Qualität & Export</button>
    </nav>
    <div class="header-actions">
      <button id="btn-preflight" title="Preflight prüfen">Preflight</button>
      <button id="btn-install" hidden>Installieren</button>
    </div>
  </header>

  <main id="main">
    <aside class="panel" id="panel">
      <section id="panel-step-1" class="panel-section visible">
        <h2>1 · Bild laden</h2>
        <p>Planskizze hochladen (PNG/JPG/SVG) oder direkt fotografieren. Ein Button, beide Optionen (OS‑Sheet).</p>
        <div class="field">
          <label class="button button-primary">
            <!-- WICHTIG: kein capture‑Attribut, damit OS die Wahl (Kamera oder Dateien) anbietet -->
            <input type="file" id="file-input" accept="image/*" hidden>
            Bild auswählen / Kamera
          </label>
        </div>
        <div class="field inline">
          <label for="rotate">Drehen</label>
          <select id="rotate">
            <option value="0">0°</option>
            <option value="90">90°</option>
            <option value="180">180°</option>
            <option value="270">270°</option>
          </select>
          <button id="btn-apply-rotation">Anwenden</button>
        </div>
        <div class="field">
          <label><input type="checkbox" id="chk-worker" checked> Verarbeitung im Hintergrund (WebWorker)</label>
        </div>
        <div class="hint">Hinweis: Keine Daten verlassen den Browser. Offline‑fähig nach dem zweiten Aufruf.</div>
      </section>

      <section id="panel-step-2" class="panel-section">
        <h2>2 · Automatik</h2>
        <div class="field inline">
          <label for="kval">Cluster (k)</label>
          <input type="range" min="5" max="8" value="6" id="kval">
          <span id="kval-label">6</span>
        </div>
        <div class="field inline">
          <label for="tol">ΔE‑Toleranz</label>
          <input type="range" min="0" max="35" value="10" id="tol">
          <span id="tol-label">10</span>
        </div>
        <div class="field inline">
          <label for="occ">Zellschwelle</label>
          <input type="range" min="10" max="90" value="40" id="occ">
          <span id="occ-label">40%</span>
        </div>
        <div class="field">
          <div id="cluster-palette" class="palette" title="Hallen‑Cluster auswählen (graue Flächen)"></div>
        </div>
        <div class="field">
          <button id="btn-run-pipeline" class="button-primary">Erstmaske erzeugen</button>
        </div>
        <details class="perf">
          <summary>Pipeline‑Timings</summary>
          <pre id="perf-report">–</pre>
        </details>
        <details>
          <summary>Ehrliche Einschätzung Auto‑Erkennung</summary>
          <p>Die Pipeline (k‑means in Lab, Sobel + Otsu, Morphologie) liefert in der Praxis eine brauchbare Erstmaske. Grenzen: Druckartefakte, Schatten, komprimierte Scans → Randfehler. Halbautomat korrigiert mit 3 Werkzeugen.</p>
        </details>
      </section>

      <section id="panel-step-3" class="panel-section">
        <h2>3 · Nacharbeit</h2>
        <div class="toolbar">
          <button data-tool="hand" class="tool active">Hand/Zoom</button>
          <button data-tool="wall" class="tool">Wand</button>
          <button data-tool="zone" class="tool">Sperrzone</button>
          <button data-tool="door" class="tool">Öffnung</button>
          <button id="btn-undo">↶ Undo</button>
          <button id="btn-redo">↷ Redo</button>
          <button id="btn-clear-window">Fenster leeren</button>
        </div>
        <p>Pinch‑Zoom, mit einem Finger ziehen. Rechtecke im Raster (10 px).</p>
        <details>
          <summary>Vorschläge für Öffnungen</summary>
          <p id="door-suggestions">Noch keine Vorschläge. Nach der Automatik erscheinen hier mögliche Tore/Öffnungen zur Bestätigung.</p>
        </details>
      </section>

      <section id="panel-step-4" class="panel-section">
        <h2>4 · Kalibrieren</h2>
        <p>Wählen Sie zwei Punkte auf dem Plan und geben Sie die Distanz in Metern ein.</p>
        <div class="field inline">
          <label for="calib-meters">Distanz (m)</label>
          <input type="number" id="calib-meters" min="0.1" step="0.1" placeholder="z. B. 12.4">
          <button id="btn-calibrate" class="button-primary">px/m berechnen</button>
        </div>
        <div class="hint" id="calib-status">Noch nicht kalibriert.</div>
      </section>

      <section id="panel-step-5" class="panel-section">
        <h2>5 · Standorte & Startpunkte</h2>
        <div class="field inline">
          <button id="btn-add-site" class="button-primary">Standort +</button>
          <button id="btn-add-start" class="button">Startpunkt +</button>
        </div>
        <ul id="list-sites" class="list"></ul>
        <ul id="list-starts" class="list"></ul>
      </section>

      <section id="panel-step-6" class="panel-section">
        <h2>6 · Qualität & Export</h2>
        <div class="field">
          <button id="btn-run-quality">Qualitätscheck</button>
          <div id="quality-report" class="report"></div>
        </div>
        <div class="field">
          <label><input type="checkbox" id="chk-embed-image" checked> Bild im Export einbetten</label>
        </div>
        <div class="field">
          <button id="btn-export" class="button-primary">bn-mapbundle.json exportieren</button>
          <button id="btn-import">Importieren…</button>
          <input type="file" id="import-input" accept="application/json" hidden>
        </div>
        <div class="field">
          <label for="meta-name">Name</label>
          <input id="meta-name" placeholder="Werk/Halle">
          <label for="meta-notes">Notizen</label>
          <textarea id="meta-notes" rows="2" placeholder="Optional…"></textarea>
        </div>
      </section>
    </aside>

    <section class="canvas-wrap">
      <canvas id="plan-canvas" width="1200" height="800"></canvas>
      <canvas id="overlay-canvas" width="1200" height="800"></canvas>
      <div class="spinner" hidden><div class="dot"></div></div>
      <div id="alerts" class="alerts"></div>
    </section>
  </main>

  <footer class="app-footer">
    <div id="status">Bereit.</div>
    <div id="calib-indicator">px/m: –</div>
    <div>Raster: 10 px</div>
  </footer>

  <noscript>Bitte JavaScript aktivieren.</noscript>
  <script type="module" src="./src/main.js"></script>
</body>
</html>
